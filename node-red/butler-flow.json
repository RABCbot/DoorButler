[{"id":"9a45335.49dd0d","type":"mqtt in","z":"83b42288.2eb27","name":"start","topic":"butler/start","qos":"2","datatype":"json","broker":"7c4ce906.75ea08","x":90,"y":140,"wires":[["cf5f4fab.23461"]]},{"id":"11c3a767.9eba09","type":"exec","z":"83b42288.2eb27","command":"aplay","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"say","x":1230,"y":180,"wires":[["66f5f871.ba6b78"],[],[]]},{"id":"86c2173d.241b08","type":"function","z":"83b42288.2eb27","name":"assign","func":"msg.retry = msg.retry + 1\n\nmsg.payload = \"-q \"\nmsg.payload += \"/home/pi/butler/say/\"\nmsg.payload += msg.say\nmsg.payload += \".wav\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":180,"wires":[["11c3a767.9eba09"]]},{"id":"cf0bc43e.25cd08","type":"exec","z":"83b42288.2eb27","command":"arecord","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"listen","x":430,"y":700,"wires":[["7db9bd65.a29974","239eb69.6d13e4a"],[],[]]},{"id":"56e6439e.6551cc","type":"function","z":"83b42288.2eb27","name":"assign","func":"if (msg.announce)\n    msg.payload = \"-q -d 5\"\nelse\n    msg.payload = \"-q -d 3\"\nmsg.payload += \" -t wav \"\nmsg.payload += \"/home/pi/butler/listen/response\"\nmsg.payload += msg.retry.toString()\nmsg.payload += \".wav\"\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":700,"wires":[["cf0bc43e.25cd08","c61de077.392c9"]]},{"id":"52d7e397.2179bc","type":"exec","z":"83b42288.2eb27","command":"curl","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"nlu","x":830,"y":700,"wires":[["eda8109b.b2d97"],[],[]]},{"id":"a6426b45.415018","type":"function","z":"83b42288.2eb27","name":"assign","func":"msg.payload = \"-XPOST https://api.wit.ai/speech?v=20200525 \"\nmsg.payload += \" -s\"\nmsg.payload += \" -H 'Authorization: Bearer \"\nmsg.payload += msg.token\nmsg.payload += \"'\"\nmsg.payload += \" -H 'Content-Type: audio/wav'\"\nmsg.payload += \" --data-binary @/home/pi/butler/listen/response\"\nmsg.payload += msg.retry.toString()\nmsg.payload += \".wav\"\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":700,"wires":[["52d7e397.2179bc"]]},{"id":"fea9ac5c.448fc","type":"switch","z":"83b42288.2eb27","name":"intent","property":"intent","propertyType":"msg","rules":[{"t":"eq","v":"VolumeUpIntent","vt":"str"},{"t":"eq","v":"VolumeDwIntent","vt":"str"},{"t":"eq","v":"StartIntent","vt":"str"},{"t":"eq","v":"DeliveryIntent","vt":"str"},{"t":"eq","v":"YesIntent","vt":"str"},{"t":"eq","v":"ComingIntent","vt":"str"},{"t":"eq","v":"NotComingIntent","vt":"str"},{"t":"eq","v":"NotInterestedIntent","vt":"str"},{"t":"eq","v":"LeaveIntent","vt":"str"},{"t":"eq","v":"MagicIntent","vt":"str"},{"t":"eq","v":"EndIntent","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":12,"x":470,"y":160,"wires":[["90ddf336.00498"],["19720b93.c35e64"],["77676638.fcac78"],["59548e3d.048a7"],["8f5b39bc.e12618"],["3cbfb5d.d1ec14a"],["a63000d7.4bced"],["188d1b56.723665"],["1437ce98.c1c311"],["f6a2ead4.a71738"],["abe37476.a750c8"],["23fe2054.2feba"]]},{"id":"a550dbc1.96d108","type":"json","z":"83b42288.2eb27","name":"","property":"payload","action":"","pretty":false,"x":1070,"y":720,"wires":[["a9cbe22b.299a4"]]},{"id":"cf5f4fab.23461","type":"function","z":"83b42288.2eb27","name":"assign","func":"msg.token = msg.payload.token\nmsg.volume = msg.payload.volume\nmsg.intent = msg.payload.intent\nmsg.retry = 0\nmsg.payload = util.format(\"cset numid=1 %d%%\", msg.volume)\n\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":140,"wires":[["1b6a3995.6d5076"]]},{"id":"3f1343e.d90b9bc","type":"mqtt out","z":"83b42288.2eb27","name":"intent","topic":"butler/intent","qos":"","retain":"","broker":"7c4ce906.75ea08","x":290,"y":760,"wires":[]},{"id":"fa0b1616.4c9a48","type":"rpi-gpio in","z":"83b42288.2eb27","name":"","pin":"16","intype":"up","debounce":"25","read":false,"x":100,"y":300,"wires":[["cb3ed3a.d03083"]]},{"id":"cb3ed3a.d03083","type":"switch","z":"83b42288.2eb27","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":230,"y":300,"wires":[["e1167999.c946f8"]]},{"id":"f537a4fc.8b5a28","type":"exec","z":"83b42288.2eb27","command":"amixer","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"mixer","x":710,"y":40,"wires":[["77676638.fcac78"],[],[]]},{"id":"e8f7fe44.894ba","type":"link out","z":"83b42288.2eb27","name":"IntentOut","links":["4d204f21.d7ced"],"x":1275,"y":680,"wires":[]},{"id":"4d204f21.d7ced","type":"link in","z":"83b42288.2eb27","name":"IntentIn","links":["e8f7fe44.894ba","9f8e0afb.f68e98","70601700.86f5f8","e2f006e0.6171d8"],"x":355,"y":200,"wires":[["fea9ac5c.448fc"]]},{"id":"77676638.fcac78","type":"function","z":"83b42288.2eb27","name":"who","func":"msg.say = \"ask-who\"\nmsg.record = true\nmsg.announce = false\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":20,"wires":[["86c2173d.241b08"]]},{"id":"59548e3d.048a7","type":"function","z":"83b42288.2eb27","name":"signature","func":"msg.say = \"ask-signature\"\nmsg.record = true\n\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":60,"wires":[["86c2173d.241b08"]]},{"id":"8fff28e8.741ef8","type":"switch","z":"83b42288.2eb27","name":"listen?","property":"record","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":150,"y":700,"wires":[["56e6439e.6551cc"],["2b7f3b57.a42fc4"]]},{"id":"8f5b39bc.e12618","type":"function","z":"83b42288.2eb27","name":"announce","func":"msg.say = \"ask-announce\"\nmsg.record = true\nmsg.announce = true\nmsg.intent = \"AnnounceIntent\"\nreturn msg;\n","outputs":1,"noerr":0,"x":900,"y":100,"wires":[["86c2173d.241b08"]]},{"id":"abe37476.a750c8","type":"function","z":"83b42288.2eb27","name":"goodbye","func":"msg.say = \"say-goodbye\"\nmsg.record = false\nmsg.announce = false\nmsg.intent = \"EndIntent\"\nreturn msg;\n","outputs":1,"noerr":0,"x":900,"y":480,"wires":[["86c2173d.241b08"]]},{"id":"a9cbe22b.299a4","type":"function","z":"83b42288.2eb27","name":"assign","func":"if (msg.payload.hasOwnProperty(\"intents\") && msg.payload.intents.length > 0)\n    msg.intent = msg.payload.intents[0].name\nelse\n    msg.intent = 'NullIntent'\n\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":720,"wires":[["2b7f3b57.a42fc4","e8f7fe44.894ba"]]},{"id":"ff5bd094.24ffb","type":"rpi-gpio out","z":"83b42288.2eb27","name":"","pin":"22","set":true,"level":"0","freq":"","out":"out","x":600,"y":640,"wires":[]},{"id":"239eb69.6d13e4a","type":"change","z":"83b42288.2eb27","name":"0","rules":[{"t":"set","p":"payload","pt":"msg","to":"0","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":640,"wires":[["ff5bd094.24ffb"]]},{"id":"c61de077.392c9","type":"change","z":"83b42288.2eb27","name":"1","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":640,"wires":[["ff5bd094.24ffb"]]},{"id":"2b7f3b57.a42fc4","type":"change","z":"83b42288.2eb27","name":"payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"intent","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":160,"y":760,"wires":[["3f1343e.d90b9bc"]]},{"id":"90ddf336.00498","type":"function","z":"83b42288.2eb27","name":"up","func":"if (msg.volume <= 90)\n    msg.volume = msg.volume + 8\nelse\n    msg.volume = 98\nmsg.payload = util.format(\"cset numid=1 %d%%\", msg.volume)\n\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":20,"wires":[["f537a4fc.8b5a28"]]},{"id":"19720b93.c35e64","type":"function","z":"83b42288.2eb27","name":"dw","func":"if (msg.volume > 48)\n    msg.volume = msg.volume - 8\nelse\n    msg.volume = 40\n    \nmsg.payload = util.format(\"cset numid=1 %d%%\", msg.volume)\n\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":60,"wires":[["f537a4fc.8b5a28"]]},{"id":"ef792420.6d7a38","type":"file in","z":"83b42288.2eb27","name":"audio","filename":"","format":"","chunk":false,"sendError":false,"encoding":"none","x":830,"y":760,"wires":[["909d2d9f.540a3"]]},{"id":"267453f7.ccb11c","type":"mqtt out","z":"83b42288.2eb27","name":"announce","topic":"butler/announce","qos":"","retain":"","broker":"7c4ce906.75ea08","x":1100,"y":760,"wires":[]},{"id":"23fe2054.2feba","type":"switch","z":"83b42288.2eb27","name":"retry","property":"retry","propertyType":"msg","rules":[{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":570,"y":520,"wires":[["57f7f83e.65e568"],["592d0568.3fbc3c"],["50358a43.de7574"]]},{"id":"57f7f83e.65e568","type":"function","z":"83b42288.2eb27","name":"needdoor","func":"msg.say = \"ask-needdoor\"\nmsg.record = true\nmsg.announce = false\n\nreturn msg;\n","outputs":1,"noerr":0,"x":900,"y":520,"wires":[["86c2173d.241b08"]]},{"id":"592d0568.3fbc3c","type":"change","z":"83b42288.2eb27","name":"vol-up","rules":[{"t":"set","p":"intent","pt":"msg","to":"VolumeUpIntent","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":540,"wires":[["e2f006e0.6171d8"]]},{"id":"50358a43.de7574","type":"change","z":"83b42288.2eb27","name":"end","rules":[{"t":"set","p":"intent","pt":"msg","to":"EndIntent","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":580,"wires":[["e2f006e0.6171d8"]]},{"id":"3cbfb5d.d1ec14a","type":"function","z":"83b42288.2eb27","name":"coming","func":"msg.say = \"say-coming\"\nmsg.record = false\nmsg.announce = false\nmsg.intent = \"EndIntent\"\nreturn msg;\n","outputs":1,"noerr":0,"x":900,"y":140,"wires":[["86c2173d.241b08"]]},{"id":"a63000d7.4bced","type":"function","z":"83b42288.2eb27","name":"notcoming","func":"msg.say = \"say-notcoming\"\nmsg.record = false\nmsg.announce = false\nmsg.intent = \"EndIntent\"\nreturn msg;\n","outputs":1,"noerr":0,"x":890,"y":180,"wires":[["86c2173d.241b08"]]},{"id":"188d1b56.723665","type":"function","z":"83b42288.2eb27","name":"notinterested","func":"msg.say = \"say-notinterested\"\nmsg.record = false\nmsg.announce = false\nmsg.intent = \"EndIntent\"\nreturn msg;\n","outputs":1,"noerr":0,"x":890,"y":220,"wires":[["86c2173d.241b08"]]},{"id":"c6fb925a.fd3ec","type":"function","z":"83b42288.2eb27","name":"assign","func":"msg.filename = \"/home/pi/butler/listen/response\"\nmsg.filename += msg.retry.toString()\nmsg.filename += \".wav\"\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":760,"wires":[["ef792420.6d7a38"]]},{"id":"7db9bd65.a29974","type":"switch","z":"83b42288.2eb27","name":"nlu?","property":"announce","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":570,"y":700,"wires":[["a6426b45.415018"],["c6fb925a.fd3ec","2b7f3b57.a42fc4"]]},{"id":"308bc329.8e52cc","type":"link in","z":"83b42288.2eb27","name":"NLUin","links":["ebd7e51.3076318","66f5f871.ba6b78"],"x":55,"y":700,"wires":[["8fff28e8.741ef8"]]},{"id":"f6a2ead4.a71738","type":"function","z":"83b42288.2eb27","name":"magic","func":"msg.say = \"say-magic\"\nmsg.record = false\nmsg.announce = false\nmsg.intent = \"EndIntent\"\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":300,"wires":[["86c2173d.241b08"]]},{"id":"e2f006e0.6171d8","type":"link out","z":"83b42288.2eb27","name":"IntentOut","links":["4d204f21.d7ced"],"x":795,"y":560,"wires":[]},{"id":"1437ce98.c1c311","type":"function","z":"83b42288.2eb27","name":"leave","func":"msg.say = \"say-leave\"\nmsg.record = false\nmsg.announce = false\nmsg.intent = \"EndIntent\"\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":260,"wires":[["86c2173d.241b08"]]},{"id":"66f5f871.ba6b78","type":"link out","z":"83b42288.2eb27","name":"NLUout","links":["308bc329.8e52cc"],"x":1315,"y":180,"wires":[]},{"id":"1b6a3995.6d5076","type":"exec","z":"83b42288.2eb27","command":"amixer","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"mixer","x":330,"y":140,"wires":[["fea9ac5c.448fc"],[],[]]},{"id":"e1167999.c946f8","type":"mqtt out","z":"83b42288.2eb27","name":"pushbutton","topic":"butler/pushbutton","qos":"","retain":"","broker":"7c4ce906.75ea08","x":370,"y":300,"wires":[]},{"id":"9ea84a09.5d0478","type":"change","z":"83b42288.2eb27","name":"announce","rules":[{"t":"set","p":"intent","pt":"msg","to":"YesIntent","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1080,"y":680,"wires":[["e8f7fe44.894ba"]]},{"id":"eda8109b.b2d97","type":"switch","z":"83b42288.2eb27","name":"null?","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":950,"y":700,"wires":[["9ea84a09.5d0478"],["a550dbc1.96d108"]]},{"id":"909d2d9f.540a3","type":"base64","z":"83b42288.2eb27","name":"","action":"","property":"payload","x":960,"y":760,"wires":[["267453f7.ccb11c"]]},{"id":"7c4ce906.75ea08","type":"mqtt-broker","z":"","name":"HASS","broker":"192.168.101.113","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""}]
