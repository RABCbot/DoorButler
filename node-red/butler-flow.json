[{"id":"9a45335.49dd0d","type":"mqtt in","z":"83b42288.2eb27","name":"start","topic":"butler/dialogueManager/startSession","qos":"2","datatype":"json","broker":"7c4ce906.75ea08","x":90,"y":240,"wires":[["cf5f4fab.23461"]]},{"id":"11c3a767.9eba09","type":"exec","z":"83b42288.2eb27","command":"aplay","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"play","x":1070,"y":200,"wires":[["8fff28e8.741ef8"],[],[]]},{"id":"86c2173d.241b08","type":"function","z":"83b42288.2eb27","name":"assign","func":"msg.response = msg.response + 1\n\nmsg.payload = \"-q \"\nmsg.payload += \"/home/pi/butler/say/\"\nmsg.payload += msg.say\nmsg.payload += \".wav\"\n\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":200,"wires":[["11c3a767.9eba09"]]},{"id":"cf0bc43e.25cd08","type":"exec","z":"83b42288.2eb27","command":"arecord","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"record","x":1070,"y":265,"wires":[["a6426b45.415018","44b3fc6f.8f8904"],[],[]]},{"id":"56e6439e.6551cc","type":"function","z":"83b42288.2eb27","name":"assign","func":"msg.payload = \"-q -d 3\"\nmsg.payload += \" -t wav \"\nmsg.payload += \"/home/pi/butler/listen/response\"\nmsg.payload += msg.response.toString()\nmsg.payload += \".wav\"\n\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":265,"wires":[["cf0bc43e.25cd08"]]},{"id":"52d7e397.2179bc","type":"exec","z":"83b42288.2eb27","command":"curl","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"nlu-wit","x":1070,"y":325,"wires":[["a550dbc1.96d108"],[],[]]},{"id":"a6426b45.415018","type":"function","z":"83b42288.2eb27","name":"assign","func":"msg.payload = \"-XPOST https://api.wit.ai/speech?v=20200525 \"\nmsg.payload += \" -s\"\nmsg.payload += \" -H 'Authorization: Bearer \"\nmsg.payload += flow.get(\"token\")\nmsg.payload += \"'\"\nmsg.payload += \" -H 'Content-Type: audio/wav'\"\nmsg.payload += \" --data-binary @/home/pi/butler/listen/response\"\nmsg.payload += msg.response.toString()\nmsg.payload += \".wav\"\n\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":325,"wires":[["52d7e397.2179bc"]]},{"id":"fea9ac5c.448fc","type":"switch","z":"83b42288.2eb27","name":"intent","property":"intent","propertyType":"msg","rules":[{"t":"eq","v":"StartIntent","vt":"str"},{"t":"eq","v":"VolumeUpIntent","vt":"str"},{"t":"eq","v":"VolumeDwIntent","vt":"str"},{"t":"eq","v":"AttentionIntent","vt":"str"},{"t":"eq","v":"DeliveryIntent","vt":"str"},{"t":"eq","v":"YesIntent","vt":"str"},{"t":"eq","v":"NoIntent","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":8,"x":330,"y":240,"wires":[["55b683a7.d0365c"],["90ddf336.00498"],["19720b93.c35e64"],["4a7b014a.a3c7"],["59548e3d.048a7"],["8f5b39bc.e12618"],["abe37476.a750c8"],["22d57fe4.03482"]]},{"id":"a550dbc1.96d108","type":"json","z":"83b42288.2eb27","name":"","property":"payload","action":"","pretty":false,"x":950,"y":385,"wires":[["a9cbe22b.299a4"]]},{"id":"cf5f4fab.23461","type":"function","z":"83b42288.2eb27","name":"assign","func":"flow.set(\"token\", msg.payload.token)\nflow.set(\"volume\", msg.payload.volume)\n\nreturn {intent: msg.payload.intent, payload: msg.payload};","outputs":1,"noerr":0,"x":210,"y":240,"wires":[["fea9ac5c.448fc"]]},{"id":"3f1343e.d90b9bc","type":"mqtt out","z":"83b42288.2eb27","name":"intent","topic":"butler/intent","qos":"","retain":"","broker":"7c4ce906.75ea08","x":1330,"y":385,"wires":[]},{"id":"55b683a7.d0365c","type":"function","z":"83b42288.2eb27","name":"assign","func":"msg.payload = util.format(\"cset numid=1 %d%%\", msg.payload.volume)\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":160,"wires":[["f537a4fc.8b5a28"]]},{"id":"f537a4fc.8b5a28","type":"exec","z":"83b42288.2eb27","command":"amixer","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"mixer","x":590,"y":200,"wires":[["77676638.fcac78"],[],[]]},{"id":"e8f7fe44.894ba","type":"link out","z":"83b42288.2eb27","name":"IntentOut","links":["4d204f21.d7ced"],"x":1155,"y":430,"wires":[]},{"id":"4d204f21.d7ced","type":"link in","z":"83b42288.2eb27","name":"IntentIn","links":["e8f7fe44.894ba","9f8e0afb.f68e98","70601700.86f5f8"],"x":235,"y":180,"wires":[["fea9ac5c.448fc"]]},{"id":"77676638.fcac78","type":"function","z":"83b42288.2eb27","name":"who","func":"msg.say = \"ask-who\"\nmsg.record = true\nmsg.response = 0\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":200,"wires":[["6d7eebef.fcb7b4"]]},{"id":"4a7b014a.a3c7","type":"function","z":"83b42288.2eb27","name":"attention","func":"msg.say = \"ask-attention\"\nmsg.record = true\n\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":300,"wires":[["6d7eebef.fcb7b4"]]},{"id":"59548e3d.048a7","type":"function","z":"83b42288.2eb27","name":"signature","func":"msg.say = \"ask-signature\"\nmsg.record = true\n\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":340,"wires":[["6d7eebef.fcb7b4"]]},{"id":"8fff28e8.741ef8","type":"switch","z":"83b42288.2eb27","name":"","property":"record","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1190,"y":200,"wires":[["2b7f3b57.a42fc4"],["507722f0.d6d73c","56e6439e.6551cc"]]},{"id":"8f5b39bc.e12618","type":"function","z":"83b42288.2eb27","name":"announce","func":"msg.say = \"say-announcingyou\"\nmsg.record = false\nmsg.intent = \"AnnounceIntent\"\nreturn msg;\n","outputs":1,"noerr":0,"x":560,"y":380,"wires":[["6d7eebef.fcb7b4"]]},{"id":"abe37476.a750c8","type":"function","z":"83b42288.2eb27","name":"goodbye","func":"msg.say = \"say-goodbye\"\nmsg.record = false\nmsg.intent = \"EndIntent\"\nreturn msg;\n","outputs":1,"noerr":0,"x":560,"y":420,"wires":[["6d7eebef.fcb7b4"]]},{"id":"22d57fe4.03482","type":"function","z":"83b42288.2eb27","name":"nointent","func":"msg.say = \"ask-nointent\"\nmsg.record = true\n\nreturn msg;\n","outputs":1,"noerr":0,"x":560,"y":460,"wires":[["6d7eebef.fcb7b4"]]},{"id":"a9cbe22b.299a4","type":"function","z":"83b42288.2eb27","name":"assign","func":"if (msg.payload.hasOwnProperty(\"intents\") && msg.payload.intents.length > 0)\n    msg.intent = msg.payload.intents[0].name\nelse\n    msg.intent = 'NullIntent'\n\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":385,"wires":[["e8f7fe44.894ba","2b7f3b57.a42fc4"]]},{"id":"ff5bd094.24ffb","type":"rpi-gpio out","z":"83b42288.2eb27","name":"","pin":"22","set":true,"level":"0","freq":"","out":"out","x":300,"y":460,"wires":[]},{"id":"239eb69.6d13e4a","type":"change","z":"83b42288.2eb27","name":"0","rules":[{"t":"set","p":"payload","pt":"msg","to":"0","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":460,"wires":[["ff5bd094.24ffb"]]},{"id":"c61de077.392c9","type":"change","z":"83b42288.2eb27","name":"1","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":520,"wires":[["ff5bd094.24ffb"]]},{"id":"6697b165.2f2df","type":"link in","z":"83b42288.2eb27","name":"LedOff","links":["44b3fc6f.8f8904"],"x":55,"y":460,"wires":[["239eb69.6d13e4a"]]},{"id":"76657c90.5dd574","type":"link in","z":"83b42288.2eb27","name":"LedOn","links":["507722f0.d6d73c","7c08391.74819c8"],"x":55,"y":520,"wires":[["c61de077.392c9"]]},{"id":"507722f0.d6d73c","type":"link out","z":"83b42288.2eb27","name":"","links":["76657c90.5dd574"],"x":1295,"y":220,"wires":[]},{"id":"44b3fc6f.8f8904","type":"link out","z":"83b42288.2eb27","name":"","links":["6697b165.2f2df"],"x":1195,"y":265,"wires":[]},{"id":"2b7f3b57.a42fc4","type":"change","z":"83b42288.2eb27","name":"payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"intent","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1200,"y":385,"wires":[["3f1343e.d90b9bc"]]},{"id":"90ddf336.00498","type":"function","z":"83b42288.2eb27","name":"assign","func":"flow.set(\"volume\", flow.get(\"volume\") + 10)\nmsg.payload = util.format(\"cset numid=1 %d%%\", flow.get(\"volume\"))\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":200,"wires":[["f537a4fc.8b5a28"]]},{"id":"19720b93.c35e64","type":"function","z":"83b42288.2eb27","name":"assign","func":"flow.set(\"volume\", flow.get(\"volume\") - 10)\nmsg.payload = util.format(\"cset numid=1 %d%%\", flow.get(\"volume\"))\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":240,"wires":[["f537a4fc.8b5a28"]]},{"id":"6d7eebef.fcb7b4","type":"switch","z":"83b42288.2eb27","name":"","property":"response","propertyType":"msg","rules":[{"t":"lt","v":"3","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":830,"y":200,"wires":[["86c2173d.241b08"]]},{"id":"7c4ce906.75ea08","type":"mqtt-broker","z":"","name":"HASS","broker":"192.168.101.113","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""}]
