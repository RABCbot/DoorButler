[{"id":"9a45335.49dd0d","type":"mqtt in","z":"83b42288.2eb27","name":"start","topic":"butler/dialogueManager/startSession","qos":"2","datatype":"json","broker":"7c4ce906.75ea08","x":110,"y":220,"wires":[["cf5f4fab.23461"]]},{"id":"11c3a767.9eba09","type":"exec","z":"83b42288.2eb27","command":"aplay","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"play","x":1050,"y":180,"wires":[["8fff28e8.741ef8"],[],[]]},{"id":"86c2173d.241b08","type":"function","z":"83b42288.2eb27","name":"assign","func":"var s = \"-q \"\ns += \"/home/pi/butler/say/\"\ns += msg.payload\ns += \".wav\"\n\nreturn {payload: s};","outputs":1,"noerr":0,"x":930,"y":180,"wires":[["11c3a767.9eba09"]]},{"id":"cf0bc43e.25cd08","type":"exec","z":"83b42288.2eb27","command":"arecord","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"record","x":1050,"y":240,"wires":[["a6426b45.415018"],[],[]]},{"id":"56e6439e.6551cc","type":"function","z":"83b42288.2eb27","name":"assign","func":"var s = \"-q -d 3\"\ns += \" -t wav \"\ns += \"/home/pi/butler/listen/response.wav\"\n\nreturn {payload: s};","outputs":1,"noerr":0,"x":930,"y":240,"wires":[["cf0bc43e.25cd08"]]},{"id":"52d7e397.2179bc","type":"exec","z":"83b42288.2eb27","command":"curl","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"nlu-wit","x":1050,"y":300,"wires":[["a550dbc1.96d108"],[],[]]},{"id":"a6426b45.415018","type":"function","z":"83b42288.2eb27","name":"assign","func":"var s = \"-XPOST https://api.wit.ai/speech?v=20200525 \"\ns += \" -s\"\ns += \" -H 'Authorization: Bearer \"\ns += flow.get(\"token\")\ns += \"'\"\ns += \" -H 'Content-Type: audio/wav'\"\ns += \" --data-binary @/home/pi/butler/listen/response.wav\"\n\nreturn {payload: s};","outputs":1,"noerr":0,"x":930,"y":300,"wires":[["52d7e397.2179bc"]]},{"id":"fea9ac5c.448fc","type":"switch","z":"83b42288.2eb27","name":"intent","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"StartIntent","vt":"str"},{"t":"eq","v":"AttentionIntent","vt":"str"},{"t":"eq","v":"DeliveryIntent","vt":"str"},{"t":"eq","v":"OtherIntent","vt":"str"},{"t":"eq","v":"YesIntent","vt":"str"},{"t":"eq","v":"NoIntent","vt":"str"},{"t":"eq","v":"ComingIntent","vt":"str"},{"t":"eq","v":"SolicitingIntent","vt":"str"},{"t":"else"},{"t":"eq","v":"VolumeUpIntent","vt":"str"},{"t":"eq","v":"VolumeDwIntent","vt":"str"}],"checkall":"true","repair":false,"outputs":11,"x":370,"y":220,"wires":[["77676638.fcac78"],["4a7b014a.a3c7"],["59548e3d.048a7"],["88860808.91a218"],[],[],[],["abe37476.a750c8"],["22d57fe4.03482"],["55b683a7.d0365c"],["9e5edd30.da16e"]]},{"id":"a550dbc1.96d108","type":"json","z":"83b42288.2eb27","name":"","property":"payload","action":"","pretty":false,"x":930,"y":360,"wires":[["72540216.d5f0ec"]]},{"id":"72540216.d5f0ec","type":"change","z":"83b42288.2eb27","name":"assign","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.intents[0].name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1050,"y":360,"wires":[["3f1343e.d90b9bc","e8f7fe44.894ba"]]},{"id":"cf5f4fab.23461","type":"function","z":"83b42288.2eb27","name":"token","func":"flow.set(\"token\", msg.payload.token)\nflow.set(\"volume\", 75)\nreturn {payload: msg.payload.intent};","outputs":1,"noerr":0,"x":230,"y":220,"wires":[["fea9ac5c.448fc","55b683a7.d0365c"]]},{"id":"3f1343e.d90b9bc","type":"mqtt out","z":"83b42288.2eb27","name":"intent","topic":"butler/intent","qos":"","retain":"","broker":"7c4ce906.75ea08","x":1170,"y":360,"wires":[]},{"id":"55b683a7.d0365c","type":"function","z":"83b42288.2eb27","name":"volume-up","func":"var v = flow.get(\"volume\")\nif(v < 90) v = v + 5; else v = 90;\nflow.set(\"volume\", v)\nvar s = util.format(\"cset numid=1 %d%%\", v)\n\nreturn {payload: s};","outputs":1,"noerr":0,"x":590,"y":500,"wires":[["f537a4fc.8b5a28"]]},{"id":"f537a4fc.8b5a28","type":"exec","z":"83b42288.2eb27","command":"amixer","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"mixer","x":750,"y":500,"wires":[[],[],[]]},{"id":"e8f7fe44.894ba","type":"link out","z":"83b42288.2eb27","name":"","links":["4d204f21.d7ced"],"x":1135,"y":420,"wires":[]},{"id":"4d204f21.d7ced","type":"link in","z":"83b42288.2eb27","name":"","links":["e8f7fe44.894ba"],"x":275,"y":260,"wires":[["fea9ac5c.448fc"]]},{"id":"77676638.fcac78","type":"function","z":"83b42288.2eb27","name":"ask-reason","func":"flow.set(\"record\", true)\nreturn {payload: \"ask-reason\"};","outputs":1,"noerr":0,"x":590,"y":180,"wires":[["86c2173d.241b08"]]},{"id":"4a7b014a.a3c7","type":"function","z":"83b42288.2eb27","name":"ask-attention","func":"flow.set(\"record\", true)\nreturn {payload: \"ask-attention\"};","outputs":1,"noerr":0,"x":590,"y":220,"wires":[["86c2173d.241b08"]]},{"id":"59548e3d.048a7","type":"function","z":"83b42288.2eb27","name":"ask-signature","func":"flow.set(\"record\", true)\nreturn {payload: \"ask-signature\"};","outputs":1,"noerr":0,"x":600,"y":260,"wires":[["86c2173d.241b08"]]},{"id":"88860808.91a218","type":"function","z":"83b42288.2eb27","name":"ask-presence","func":"flow.set(\"record\", true)\nreturn {payload: \"ask-presence\"};","outputs":1,"noerr":0,"x":600,"y":300,"wires":[["86c2173d.241b08"]]},{"id":"8fff28e8.741ef8","type":"switch","z":"83b42288.2eb27","name":"","property":"record","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1170,"y":180,"wires":[["56e6439e.6551cc"]]},{"id":"8f5b39bc.e12618","type":"function","z":"83b42288.2eb27","name":"say-coming","func":"flow.set(\"record\", false)\nreturn {payload: \"say-coming\"};","outputs":1,"noerr":0,"x":590,"y":360,"wires":[["86c2173d.241b08"]]},{"id":"abe37476.a750c8","type":"function","z":"83b42288.2eb27","name":"say-goodbye","func":"flow.set(\"record\", false)\nreturn {payload: \"say-goodbye\"};","outputs":1,"noerr":0,"x":590,"y":400,"wires":[["86c2173d.241b08"]]},{"id":"22d57fe4.03482","type":"function","z":"83b42288.2eb27","name":"say-nointent","func":"flow.set(\"record\", false)\nreturn {payload: \"say-nointent\"};","outputs":1,"noerr":0,"x":590,"y":440,"wires":[["86c2173d.241b08"]]},{"id":"9e5edd30.da16e","type":"function","z":"83b42288.2eb27","name":"volume-down","func":"var v = flow.get(\"volume\")\nif(v > 50) v = v - 5; else v = 50;\nflow.set(\"volume\", v)\nvar s = util.format(\"cset numid=1 %d%%\", v)\n\nreturn {payload: s};","outputs":1,"noerr":0,"x":590,"y":540,"wires":[["f537a4fc.8b5a28"]]},{"id":"7c4ce906.75ea08","type":"mqtt-broker","z":"","name":"HASS","broker":"192.168.101.113","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""}]
